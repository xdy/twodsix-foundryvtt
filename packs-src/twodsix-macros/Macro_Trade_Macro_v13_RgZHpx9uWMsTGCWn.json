{
  "name": "Trade Macro v13",
  "type": "script",
  "author": "g35c71Hsyv7w1Lw4",
  "img": "systems/twodsix/assets/icons/cargo-crate.svg",
  "scope": "global",
  "command": "// Macro to generated trade goods pricing and quantities for sale based on\n// planet UPP and a trader modier for skill attributes\n// Updated for FVTT 13\n\nconst DEBUG = false; // Display debuggin info to console\nconst RANDOM = true; // Whether trade goods for player to buy are seelcted at random (true).  Otherwise, goods available are determined by trade codes.\ngenerateTable();\n\nasync function generateTable () {\n  let uwp = 0;\n  let traderDM = 0;\n  let compendium = '';\n  await new Promise((resolve) => {\n    new foundry.applications.api.DialogV2({\n      content: `<input placeholder = \"World UWP\" type=\"text\" name=\"uwp\"/>\n      <input placeholder = \"Trader DM\" type=\"number\" name=\"traderDM\"/>`,\n      window: {\n        title: 'Generate Trade Table',\n        icon: 'fa-solid fa-globe'\n      },\n      buttons: [\n        {\n          action: 'CE',\n          label: 'Cepheus Engine',\n          callback: (_event, target) => {\n            resolve(uwp = target.form.elements.uwp.value,\n              traderDM = target.form.elements.traderDM.value,\n              compendium = 'CE');\n          },\n          default: true\n        },\n        {\n          action: 'CL',\n          label: 'Cepheus Light',\n          callback: (_event, target) => {\n            resolve(uwp = target.form.elements.uwp.value,\n              traderDM = target.form.elements.traderDM.value,\n              compendium = 'CL');\n          }\n        }\n      ]\n\n    }).render(true);\n  });\n\n  const tcodes = getTradeCode(uwp);\n  const starBase = uwp[0];\n  if (traderDM === '') {\n    traderDM = 0;\n  }\n\n  if (DEBUG) {\n    console.log('Trade codes:', tcodes);\n  }\n  if (DEBUG) {\n    console.log('UWP: ', uwp, traderDM);\n  }\n\n  let tradeTable = '';\n  tradeTable +=\n      await processTradeTable('Advanced Trade Goods - ' + compendium, tcodes,\n        parseInt(traderDM), compendium, starBase);\n\n  tradeTable += await processTradeTable('Basic Goods - ' + compendium, tcodes,\n    parseInt(traderDM), compendium, starBase);\n  const htmlContent =  `<table><tbody><tr>\n      <th style=\"text-align:left\">Good</th>\n      <th style=\"text-align:center\">Available to Buy (tons)</th>\n      <th style=\"text-align:center\">Player Buys (Cr)</th>\n      <th style=\"text-align:center\">Player Sells (Cr)</th></tr>\n      ${tradeTable}\n      </tbody></table>`;\n\n  await new Promise((resolve) => {\n    new foundry.applications.api.DialogV2({\n      modal: true,\n      window: {\n        title: `Trade Table for: ${uwp}`,\n        icon: 'fa-solid fa-money-bill-trend-up'\n      },\n      content: htmlContent,\n      buttons: [\n        {\n          action: \"ok\",\n          label: 'Ok',\n          callback: (_event, target) => {\n            resolve(target.form.elements.input.value);\n          },\n          height: '12px',\n          resizable: true,\n        },\n        {\n          action: 'output',\n\t        label: 'Output',\n          callback: async () => {\n            const newJournal = await JournalEntry.create({name: `Trade Output`});\n            newJournal.createEmbeddedDocuments(\"JournalEntryPage\",[{\n              text: {content: htmlContent},\n              name: uwp\n            }]);\n          },\n          height: '12px',\n          resizable: true,\n        }\n      ]\n    },\n    { width: 700, height: 600 })\n      .render(true);\n  });\n}\n\nasync function processTradeTable (tableName, trcodes, offset, compendium, starBase) {\n  let returnText = '';\n  let isAvailable = [];\n  const table = await game.tables.contents.find(t => t.name === tableName);\n\n  // If random selection, determine trade goods available\n  if (tableName.indexOf('Basic') === -1 && RANDOM) {\n    isAvailable = await determineGoods(table, compendium, starBase);\n  }\n  if (DEBUG) {\n    console.log(isAvailable);\n  }\n\n  // Process each item (good) in table\n  for (let row = 0; row < table.results.size; ++row) {\n    // Parse row of table that is tab delimited\n    const details = table.results._source[row].text.split('\\t');\n\n    let tons = 0;\n    let pSellPr = 0;\n    let pBuyPr = 0;\n    let pBuyMod = 0;\n    let pSellMod = 0;\n\n    // Determine planet trade code price DMs\n    switch (compendium) {\n      case 'CL':\n        pSellMod = getMod(trcodes, details[4]);\n        pBuyMod = getMod(trcodes, details[3]);\n        break;\n      case 'CE':\n        pSellMod = getMod(trcodes, details[4]) - getMod(trcodes, details[3]);\n        pBuyMod = getMod(trcodes, details[3]) - getMod(trcodes, details[4]);\n        break;\n    }\n\n    if (DEBUG) {\n      console.log('Name: ', details[0]);\n    }\n    if (DEBUG) {\n      console.log('pSellMod:', pSellMod);\n    }\n    if (DEBUG) {\n      console.log('pBuyMod:', pBuyMod);\n    }\n\n    // Determine tons available for player to buy\n    if (RANDOM) {\n      tons = new Roll('@dice', { dice: details[2] });\n      tons = (await tons.evaluate()).total;\n      if (tableName.indexOf('Basic') === -1) {\n        tons *= isAvailable[row];\n      }\n    } else {\n      if ((tableName.indexOf('Basic') !== -1) ||\n          (availableGood(trcodes, details[3]))) {\n        tons = new Roll('@dice', { dice: details[2] });\n        tons = (await tons.evaluate()).total;\n      }\n    }\n\n    // Determine Player Buys price\n    if (tons === 0) {\n      tons = '---';\n      pBuyPr = '---';\n    } else {\n      pBuyPr = Math.round(details[1] * (await rollPriceAdjust(pBuyMod + offset, 'buy', compendium)));\n    }\n\n    // Determine Player Sells price\n    pSellPr = Math.round(\n      details[1] * (await rollPriceAdjust(pSellMod + offset, 'sell', compendium)));\n\n    // generate buy-sell table row in html\n    if (row === table.results.size - 1) {\n      returnText +=\n          `<tr style=\"border-bottom:1px solid red\"><td style=\"padding-right:5px\">${details[0]}</td>`;\n    } else {\n      returnText += `<tr><td style=\"padding-right:5px\">${details[0]}</td>`;\n    }\n\n    returnText += `<td style=\"padding-right:5px; text-align:center\">${tons}</td>\n    <td style=\"padding-right:5px; text-align:center\">${pBuyPr}</td><td style=\"padding-right:5px; text-align:center\">${pSellPr}</td></tr>`;\n  }\n\n  return (returnText);\n}\n\nasync function determineGoods (table, compendium, starBase) {\n  const numItems = table.results.size;\n  // fill with zeros\n  const availList = new Uint8Array(numItems);\n\n  let baseAdj = 0;\n\n  // Calculate starport roll bonus if Cepheus Light\n  if (compendium === 'CL') {\n    switch (starBase.toUpperCase()) {\n      case 'A':\n        baseAdj = 4;\n        break;\n      case 'B':\n        baseAdj = 2;\n        break;\n      case 'C':\n        baseAdj = 1;\n        break;\n      case 'D':\n        baseAdj = 0;\n        break;\n      case 'E':\n        baseAdj = -2;\n        break;\n    }\n  }\n\n  let numDraws = new Roll('1D6+@adj', { adj: baseAdj });\n  numDraws = (await numDraws.evaluate()).total;\n  if (DEBUG) {\n    console.log('Number of Draws: ', numDraws);\n  }\n\n  if (numDraws < 1) {\n    numDraws = 1;\n  }\n\n  for (let i = 0; i < numDraws; ++i) {\n    let item = new Roll('1D@num', { num: numItems });\n    item = (await item.evaluate()).total;\n    ++availList[item - 1];\n  }\n  return (availList);\n}\n\nfunction getMod (planetTrCodes, goodCodes) {\n  let modifier = 0;\n  for (const code of planetTrCodes) {\n    const codePos = goodCodes.indexOf(code);\n    if (codePos !== -1) {\n      const codeValue = hexToBase10(goodCodes[codePos + 3]);\n      if (codeValue > modifier) {\n        modifier = codeValue;\n      }\n    }\n  }\n  return (parseInt(modifier));\n}\n\nasync function rollPriceAdjust (offset, type, compendium) {\n  let tableName = '';\n  if (type === 'sell') {\n    tableName += 'Sales Price Table';\n  } else {\n    tableName += 'Purchase Price Table';\n  }\n  tableName += ` - ${compendium}`;\n\n  if (DEBUG) {\n    console.log('Price Adjustment Table: ', tableName);\n  }\n\n  const table = game.tables.contents.find(t => t.name === tableName);\n\n  let r = new Roll('2D6+@mod', { mod: offset });\n  r = (await r.evaluate()).total;\n  const details =\n      table.results._source[Math.min(Math.max(r - 2, 0), table.results.size - 1)].text;\n\n  if (DEBUG) {\n    console.log('Roll on Adj Table: ', r);\n  }\n  if (DEBUG) {\n    console.log('Relative Price: ', details);\n  }\n  return (parseInt(details) / 100);\n}\n\nfunction availableGood (trcodes, goodCodes) {\n  for (const code of trcodes) {\n    if (goodCodes.indexOf(code) !== -1) {\n      return true;\n    }\n  }\n  return false;\n}\n\n// Generate Trade Codes per Cepheus Light Rules\nfunction getTradeCode (UWPprofile) {\n  const returnText = [];\n\n  // Strip out dash if used in profile\n  UWPprofile = UWPprofile.replace('-', '');\n\n  if (UWPprofile.length > 7) {\n    const size = hexToBase10(UWPprofile[1]);\n    const atmo = hexToBase10(UWPprofile[2]);\n    const hydro = hexToBase10(UWPprofile[3]);\n    const pop = hexToBase10(UWPprofile[4]);\n    const techL = hexToBase10(UWPprofile[7]);\n\n    if (atmo > 3 && atmo < 10 && hydro > 3 && hydro < 9 && pop > 4 && pop < 8) {\n      returnText.push('Ag');\n    }\n\n    if (size === 0 && atmo === 0 && hydro === 0) {\n      returnText.push('As');\n    }\n\n    // Different for CE\n    if (pop === 0) {\n      returnText.push('Ba');\n    }\n\n    if (atmo > 1 && hydro === 0) {\n      returnText.push('De');\n    }\n\n    if (atmo > 9 && hydro > 0) {\n      returnText.push('Fl');\n    }\n\n    if ((atmo === 5 || atmo === 6 || atmo === 8) && hydro > 3 && hydro < 10 &&\n        pop > 3 && pop < 9) {\n      returnText.push('Ga');\n    }\n\n    if (pop > 8) {\n      returnText.push('Hi');\n    }\n\n    if (techL > 11) {\n      returnText.push('Ht');\n    }\n\n    if (atmo < 2 && hydro > 0) {\n      returnText.push('Ic');\n    }\n\n    if ((atmo < 3 || atmo === 4 || atmo === 7 || atmo === 9) && pop > 8) {\n      returnText.push('In');\n    }\n\n    if (pop > 0 && pop < 4) {\n      returnText.push('Lo');\n    }\n\n    if (techL < 6) {\n      returnText.push('Lt');\n    }\n\n    if (atmo < 4 && hydro < 4 && pop > 5) {\n      returnText.push('Na');\n    }\n\n    if (pop > 3 && pop < 7) {\n      returnText.push('Ni');\n    }\n\n    if (atmo > 1 && atmo < 6 && hydro < 4) {\n      returnText.push('Po');\n    }\n\n    if ((atmo === 6 || atmo === 8) && pop > 5 && pop < 9) {\n      returnText.push('Ri');\n    }\n\n    if (hydro === 10) {\n      returnText.push('Wa');\n    }\n\n    if (atmo === 0) {\n      returnText.push('Va');\n    }\n  }\n  return (returnText);\n}\n\n// Convert hex value to base10\nfunction hexToBase10 (value) {\n  switch (value.toUpperCase()) {\n    case 'A':\n      return (10);\n    case 'B':\n      return (11);\n    case 'C':\n      return (12);\n    case 'D':\n      return (13);\n    case 'E':\n      return (14);\n    case 'F':\n      return (15);\n    case 'G':\n      return (16);\n    default:\n      return (Number(value));\n  }\n}",
  "flags": {
    "core": {},
    "cf": {
      "id": "temp_fjmheaydrno"
    }
  },
  "ownership": {
    "default": 0,
    "g35c71Hsyv7w1Lw4": 3
  },
  "_stats": {
    "compendiumSource": "Macro.Ao2uIf0VLS429nZW",
    "duplicateSource": null,
    "coreVersion": "13.350",
    "systemId": "twodsix",
    "systemVersion": "6.8.1",
    "createdTime": 1738176335523,
    "modifiedTime": 1760016422570,
    "lastModifiedBy": "g35c71Hsyv7w1Lw4",
    "exportSource": null
  },
  "folder": null,
  "_id": "RgZHpx9uWMsTGCWn",
  "sort": 1500000,
  "_key": "!macros!RgZHpx9uWMsTGCWn"
}
