{
  "name": "CL Character Importer v13",
  "type": "script",
  "author": "g35c71Hsyv7w1Lw4",
  "img": "icons/svg/down.svg",
  "scope": "global",
  "command": "// Take text block from https://cepheuslightgen.herokuapp.com/ and translate\n// into a Cepheus Light character\n// For Foundry VTT version v13+\ngetInputText();\n\n// Get text block and process\nasync function getInputText () {\n  // Get Input\n  const rawText = await new Promise((resolve) => {\n    new foundry.applications.api.DialogV2({\n      modal: true,\n      window: {\n        title: 'Copy and paste text for a single character',\n        icon: 'fa-solid fa-file-import'\n      },\n      content:\n          `<label>Must select just the character block</label><textarea type=\"text\" name=\"input\" cols=\"40\" rows=\"5\"></textarea>`,\n      buttons: [\n        {\n          action: 'OK',\n          label: `Process`,\n          callback:\n          (_event, target) => {\n            resolve(target.form.elements.input.value);\n          }\n        }\n      ]\n    }).render(true);\n  });\n\n  // Abort if no text entered\n  if (rawText.length === 0) {\n    return;\n  }\n\n  // split input into lines of text\n  const processedText = rawText.split('\\n');\n  let line = 0;\n\n  // break up first line which is of the generic format \"honorific name(s) UPP\n  // Age #\"\n  const posAge = processedText[line].indexOf('Age');\n  const age = parseInt(processedText[line].slice(posAge + 4));\n  const upp = processedText[line].slice(posAge - 8, posAge - 2).trim();\n  const fullName = processedText[line].slice(0, posAge - 9).trim();\n\n  // create new actor\n  const actor = await Actor.create({ name: fullName, type: 'traveller' });\n\n  ++line;\n\n  // process second line which is the homeworld\n  const homeworld =\n      processedText[line].slice(processedText[line].indexOf(':') + 2);\n  ++line;\n\n  // Process third line which is of the generic format \"careers(terms)  Cr#\"\n  const posCr = processedText[line].indexOf('Cr');\n\n  const credits = parseInt(processedText[line].slice(posCr + 2));\n  let cash = 0;\n  let debt = 0;\n  if (credits >= 0) {\n    cash = credits;\n  } else {\n    debt = -credits;\n  }\n\n  let bio = '<p>Career(s): ' + processedText[line].slice(0, posCr - 3) + '</p>';\n\n  // Enter basic character data\n  await actor.update({\n    'system.name': fullName,\n    'name': fullName,\n    'system.age.value': age,\n    'system.finances.cash': cash,\n    'system.finances.debt': debt,\n    'system.bio': bio,\n    'system.homeWorld': homeworld\n  });\n\n  // define characteristic order for UPP\n  const uppOrder = [\n    'strength', 'dexterity', 'endurance', 'intelligence', 'education',\n    'socialStanding'\n  ];\n\n  let charId = '';\n  // enter characteristic values\n  for (let i = 0; i < Math.min(upp.length, uppOrder.length); ++i) {\n    charId = 'system.characteristics.' + uppOrder[i] + '.value';\n    await actor.update({ [charId]: hexToBase10(upp[i]) });\n  }\n\n  // Open Compendium\n  const pack = await game.packs.get('twodsix.cepheus-light-items').getDocuments();\n  const itemsToAdd = [];\n\n  // Jump to muster out benefits\n  line += 2;\n  if (processedText[line] !== '') {\n    bio += '<p>Muster Out Benefits: ' + processedText[line] + '</p>';\n\n    // Try to add items from benefits\n    const itemList = processedText[line].split(', ');\n\n    for (let i = 0; i < itemList.length; ++i) {\n      let benefit = itemList[i].slice(0, itemList[i].lastIndexOf('x') - 1).trim();\n      benefit = compendiumErrors(benefit);\n\n      let newItem = pack.find(s => s.name === benefit)?.toObject();\n\n      if (newItem) {\n        const quant = parseInt(itemList[i].slice(itemList[i].lastIndexOf('x') + 1));\n        newItem.system.quantity = quant;\n        itemsToAdd.push(Object.assign({}, newItem));\n      }\n    }\n  }\n\n  line += 2;\n\n  // generate array of skill-level pairs\n  let cleanSkills = processedText[line].trim(); // get rid of extra whitespace\n  if (cleanSkills[cleanSkills.length - 1] ===\n      ',') { // Get rid of end of string ',' if present\n    cleanSkills = cleanSkills.slice(0, -1);\n  }\n  const skillsList = cleanSkills.split(\n    ', '); // make an array of individual skill-level entries\n\n  // Process skills list\n  for (let i = 0; i < skillsList.length; ++i) {\n    const skillPair = skillsList[i].trim();\n    let skillName = skillPair.slice(0, skillPair.length - 2).trim();\n    const skillLevel = parseInt(skillPair.slice(skillPair.length - 2));\n\n    let skillItem = pack.find(s => s.name === skillName && s.type === 'skills')?.toObject();\n\n    // Try to correct a null skillItem\n    if (!skillItem) {\n      skillName = compendiumErrors(skillName);\n      skillItem = pack.find(s => s.name === skillName && s.type === 'skills')?.toObject();\n    }\n\n    // Add new skill\n    if (skillItem) {\n      skillItem.system.value = skillLevel;\n      //skillItem.system.characteristic =  'NONE';\n      //skillItem.system.name = skillItem.name;\n      itemsToAdd.push(Object.assign({}, skillItem));\n    } else {\n      bio += '<p>Unknown skill: ' + skillsList[i] + '</p>';\n    }\n  }\n  await actor.createEmbeddedDocuments('Item', itemsToAdd);\n  await actor.update({ 'system.bio': bio });\n\n  // Show new actor\n  actor.sheet.render(true);\n}\n\n// Convert hex value to base10\nfunction hexToBase10 (value) {\n  switch (value.toUpperCase()) {\n    case 'A':\n      return ('10');\n    case 'B':\n      return ('11');\n    case 'C':\n      return ('12');\n    case 'D':\n      return ('13');\n    case 'E':\n      return ('14');\n    case 'F':\n      return ('15');\n    case 'G':\n      return ('16');\n    default:\n      return (value);\n  }\n}\n\nfunction compendiumErrors (skillName) {\n  switch (skillName) {\n    case 'Leader':\n      return ('Leadership');\n    case 'Survival':\n      return ('Survival ');\n    case 'Piercing Weapons':\n      return ('Melee Weapons (Piercing Weapons)');\n    case 'Jack-o-Trades':\n      return ('Jack-of-All-Trades');\n    case 'Jack o\\' Trades':\n      return ('Jack-of-All-Trades');\n    case 'Melee Combat':\n      return ('Melee');\n    case 'Demolitions':\n      return ('Demolition / Explosives');\n    case 'Autopistol':\n      return ('Auto Pistol');\n    case 'Carousing':\n      return ('Carouse');\n    case 'Computer':\n      return ('Computers');\n    case 'Administration':\n      return ('Admin');\n    case 'Investigation':\n      return ('Investigate');\n    case 'Grav Vehicle':\n      return ('Grav Vehicles');\n    case 'Great Axe':\n      return ('Axe');\n    case 'Vibro-Blade':\n      return ('Vibro-blade');\n    default:\n      return (skillName);\n  }\n}",
  "flags": {
    "core": {},
    "cf": {
      "id": "temp_f2ldg9aw4y"
    }
  },
  "ownership": {
    "default": 0,
    "msuh6wePTuFs4VOF": 3,
    "OIomk1IgyRly5ocC": 3,
    "g35c71Hsyv7w1Lw4": 3
  },
  "_stats": {
    "compendiumSource": "Macro.FSdELypGtTixFVv5",
    "duplicateSource": null,
    "coreVersion": "13.350",
    "systemId": "twodsix",
    "systemVersion": "6.8.1",
    "createdTime": 1738176314508,
    "modifiedTime": 1760016422561,
    "lastModifiedBy": "g35c71Hsyv7w1Lw4",
    "exportSource": null
  },
  "folder": null,
  "_id": "CZYmzxgavuixQbJj",
  "sort": 1000000,
  "_key": "!macros!CZYmzxgavuixQbJj"
}
