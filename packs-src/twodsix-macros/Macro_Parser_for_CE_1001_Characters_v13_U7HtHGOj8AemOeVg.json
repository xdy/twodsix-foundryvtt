{
  "name": "Parser for CE 1001 Characters v13",
  "type": "script",
  "author": "g35c71Hsyv7w1Lw4",
  "img": "icons/svg/wall-direction.svg",
  "scope": "global",
  "command": "// Take text block from\n// http://members.ozemail.com.au/~jonoreita/SupplementOne/Cepheus_Engine_1001_characters.html\n// and translate into a character skills must be separated by commas\n//Updated for v13+\n\nlet compendium = '';\n\ngetInputText();\n\n// Get text block and process\nasync function getInputText () {\n  // Get Input\n  const rawText = await new Promise((resolve) => {\n    new foundry.applications.api.DialogV2({\n      modal: true,\n      window: {\n        title: 'Copy and paste text for a single character',\n        icon: 'fa-solid fa-file-import'\n      },\n      content:\n          `<label>Must select comma separated skills</label><textarea type=\"text\" name=\"input\" cols=\"40\" rows=\"5\"></textarea>`,\n      buttons: [\n        {\n          action: 'CE',\n          label: `Cepheus Engine`,\n          callback: (_event, target) => {\n            compendium = 'CE';\n            resolve(target.form.elements.input.value);\n          }\n        },\n        {\n          action: 'CEL',\n          label: `Cepheus Light`,\n          callback: (_event, target) => {\n            compendium = 'CL';\n            resolve(target.form.elements.input.value);\n          }\n        }\n      ]\n    }).render(true);\n  });\n\n  // Abort if no text entered\n  if (rawText.length === 0) {\n    return;\n  }\n\n  // split input into lines of text\n  const processedText = rawText.split('\\n');\n  let line = 0;\n\n  // Process first line which is of the generic format \"#. honorific name(s)\n  // (gender, species) UPP Age #\"\n\n  // locate key positions on first line\n  let startName = 0;\n\n  if (processedText[line].indexOf('.') !== -1) {\n    startName =\n        processedText[line].indexOf('.') + 2; // Adjust for numbered character\n  }\n  const posOpenParen = processedText[line].indexOf('(');\n  const posCloseParen = processedText[line].indexOf(')');\n  const posAge = processedText[line].indexOf('Age');\n\n  // break up first line\n  const fullName = processedText[line].slice(startName, posOpenParen - 1);\n  const genderSpecies =\n      processedText[line].slice(posOpenParen + 1, posCloseParen).split(' ');\n  let upp = processedText[line].slice(posCloseParen + 2, posAge - 1);\n  upp = upp.replace('-', ''); // remove dash if psionic\n  const age = processedText[line].slice(posAge + 4);\n\n  // create new actor\n  const actor = await Actor.create({ name: fullName, type: 'traveller' });\n\n  ++line;\n\n  // Process second line which is of the generic format \"careers(terms)  Cr#\"\n  const posCr = processedText[line].indexOf('Cr');\n\n  const credits = processedText[line].slice(posCr + 2);\n  let cash = 0;\n  let debt = 0;\n  if (credits >= 0) {\n    cash = credits;\n  } else {\n    debt = -credits;\n  }\n\n  let bio = '<p>Career(s): ' + processedText[line].slice(0, posCr - 3) + '</p>';\n\n  // Enter basic character data\n  await actor.update({\n    'system.name': fullName,\n    'name': fullName,\n    'system.age.value': age,\n    'system.gender': genderSpecies[0],\n    'system.species': genderSpecies[1],\n    'system.finances.cash': cash,\n    'system.finances.debt': debt\n  });\n\n  ++line;\n\n  // Check for traits for non-humans and add to bio\n  if (genderSpecies[1] !== 'Human') {\n    bio += '<p>' + processedText[line] + '</p>';\n    ++line;\n  }\n\n  // define characteristic order for UPP\n  const uppOrder = [\n    'strength', 'dexterity', 'endurance', 'intelligence', 'education',\n    'socialStanding', 'psionicStrength'\n  ];\n\n  let charId = '';\n  // enter characteristic values\n  for (let i = 0; i < Math.min(upp.length, uppOrder.length); ++i) {\n    charId = 'system.characteristics.' + uppOrder[i] + '.value';\n    await actor.update({ [charId]: hexToBase10(upp[i]) });\n  }\n\n  // generate array of skill-level pairs\n  let cleanSkills = processedText[line].trim(); // get rid of extra whitespace\n\n  // Get rid of end of string ',' if present\n  if (cleanSkills[cleanSkills.length - 1] === ',') {\n    cleanSkills = cleanSkills.slice(0, -1);\n  }\n\n  // make an array of individual skill-level entries\n  const skillsList = cleanSkills.split(', ');\n\n  // Open Compendium\n  let packName = '';\n  switch (compendium) {\n    case 'CE':\n      packName = 'twodsix.ce-srd-items';\n      break;\n    case 'CL':\n      packName = 'twodsix.cepheus-light-items';\n      break;\n  }\n  const pack = await game.packs.get(packName).getDocuments();\n\n  // Process skills list\n  for (let i = 0; i < skillsList.length; ++i) {\n    const lastDash = skillsList[i].lastIndexOf('-'); // Some skills have dash in name, so last one is the marker\n    const skillName = skillsList[i].slice(0, lastDash);\n    let skillLevel = skillsList[i].slice(lastDash + 1);\n\n    let adjName = translateSkillName(skillName);\n\n    let skillItem = await pack.find(s => s.name === adjName && s.type === 'skills');\n\n    // Try to correct a null skillItem\n    if (skillItem === null || skillItem === undefined) {\n      adjName = compendiumErrors(skillName);\n      skillItem = await pack.find(s => s.name === adjName && s.type === 'skills');\n    }\n\n    // Add new skill if it doesn't exist, pick higher level to add if it does\n    if (skillItem != null) {\n      let newSkill = await actor.items.find(item => item.name === adjName);\n\n      if (newSkill == null) {\n        await actor.createEmbeddedDocuments('Item', [skillItem]);\n        newSkill = await actor.items.find(item => item.name === adjName);\n      } else {\n        skillLevel = Math.max(skillLevel, newSkill.system.value);\n      }\n\n      await newSkill.update(\n        { 'system.value': skillLevel, 'system.characteristic': 'NONE' });\n    } else {\n      bio += '<p>Unknown skill: ' + skillsList[i] + '</p>';\n    }\n  }\n\n  ++line;\n\n  // Process rest of bio\n\n  // Check for muster out benefits, optional line\n  if (processedText[line] !== 'Character Event Log:') {\n    // Try to add items from benefits\n    const itemList = processedText[line].split(', ');\n\n    for (let i = 0; i < itemList.length; ++i) {\n      const newItem = await pack.find(s => s.name === itemList[i]);\n      if (newItem != null) {\n        await actor.createEmbeddedDocuments('Item', [newItem]);\n      }\n    }\n\n    bio += '<p>Muster Out Benefits: ' + processedText[line] + '</p>';\n    ++line;\n  }\n\n  // Add character event log to bio\n  for (let i = line; i < processedText.length; ++i) {\n    bio += '<p>' + processedText[i] + '</p>';\n  }\n  await actor.update({ 'system.bio': bio });\n\n  // Show new actor\n  actor.sheet.render(true);\n}\n\n// Convert hex value to base10\nfunction hexToBase10 (value) {\n  switch (value.toUpperCase()) {\n    case 'A':\n      return ('10');\n    case 'B':\n      return ('11');\n    case 'C':\n      return ('12');\n    case 'D':\n      return ('13');\n    case 'E':\n      return ('14');\n    case 'F':\n      return ('15');\n    case 'G':\n      return ('16');\n    default:\n      return (value);\n  }\n}\n\n// Convert Abbreviated Skill Name to Full Compendium Name\nfunction translateSkillName (skillName) {\n  switch (skillName) {\n    case 'Grav Vehicle':\n    case 'Rotor Aircraft':\n    case 'Winged Aircraft':\n      switch (compendium) {\n        case 'CE':\n          return ('Aircraft (' + skillName + ')');\n        case 'CL':\n          return ('Aircraft');\n      }\n      break;\n    case 'Farming':\n    case 'Riding':\n    case 'Veterinary Medicine':\n      switch (compendium) {\n        case 'CE':\n          return ('Animals (' + skillName + ')');\n        case 'CL':\n          return ('Animals');\n      }\n      break;\n      // case 'Survival':\n    case 'Archery':\n    case 'Energy Pistol':\n    case 'Energy Rifle':\n    case 'Shotguns':\n    case 'Shotgun':\n    case 'Slug Pistol':\n    case 'Slug Rifle':\n      switch (compendium) {\n        case 'CE':\n          return ('Gun Combat (' + skillName + ')');\n        case 'CL':\n          return ('Gun Combat');\n      }\n      break;\n    case 'Bay Weapons':\n    case 'Heavy Weapons':\n    case 'Screens':\n    case 'Spinal Mounts':\n    case 'Turret Weapons':\n      switch (compendium) {\n        case 'CE':\n          return ('Gunnery (' + skillName + ')');\n        case 'CL':\n          if (skillName === 'Heavy Weapons') {\n            return (skillName);\n          } else {\n            return ('Gunnery');\n          }\n      }\n      break;\n    case 'Bludgeoning Weapons':\n    case 'Natural Weapons':\n    case 'Slashing Weapons':\n    case 'Piercing Weapons':\n      switch (compendium) {\n        case 'CE':\n          return ('Melee Combat (' + skillName + ')');\n        case 'CL':\n          return ('Melee');\n      }\n      break;\n    case 'Life Sciences':\n    case 'Physical Sciences':\n    case 'Social Sciences':\n    case 'Space Sciences':\n      switch (compendium) {\n        case 'CE':\n          return ('Science (' + skillName + ')');\n        case 'CL':\n          return ('Science');\n      }\n      break;\n    case 'Mole':\n    case 'Tracked Vehicle':\n    case 'Wheeled Vehicle':\n      switch (compendium) {\n        case 'CE':\n          return ('Vehicle (' + skillName + ')');\n        case 'CL':\n          return ('Driving');\n      }\n      break;\n    case 'Motorboats':\n    case 'Ocean Ships':\n    case 'Sailing Ships':\n    case 'Submarine':\n      switch (compendium) {\n        case 'CE':\n          return ('Watercraft (' + skillName + ')');\n        case 'CL':\n          return ('Watercraft');\n      }\n      break;\n    case 'Battle Dress':\n      switch (compendium) {\n        case 'CE':\n          return (skillName);\n        case 'CL':\n          return ('Zero-G');\n      }\n      break;\n    case 'Gambling':\n    case 'Carousing':\n      switch (compendium) {\n        case 'CE':\n          return (skillName);\n        case 'CL':\n          return ('Carouse');\n      }\n      break;\n    case 'Computer':\n    case 'Comms':\n      switch (compendium) {\n        case 'CE':\n          return (skillName);\n        case 'CL':\n          return ('Computers');\n      }\n      break;\n    case 'Electronics':\n    case 'Mechanics':\n    case 'Gravitics':\n      switch (compendium) {\n        case 'CE':\n          return (skillName);\n        case 'CL':\n          return ('Repair');\n      }\n      break;\n    case 'Navigation':\n      switch (compendium) {\n        case 'CE':\n          return (skillName);\n        case 'CL':\n          return ('Piloting');\n      }\n      break;\n    case 'Broker':\n    case 'Bribery':\n      switch (compendium) {\n        case 'CE':\n          return (skillName);\n        case 'CL':\n          return ('Liaison');\n      }\n      break;\n    case 'Advocate':\n      switch (compendium) {\n        case 'CE':\n          return (skillName);\n        case 'CL':\n          return ('Admin');\n      }\n      break;\n    default:\n      return (skillName);\n  }\n}\n\nfunction compendiumErrors (skillName) {\n  switch (skillName) {\n    case 'Leader':\n      return ('Leadership');\n    case 'Survival':\n      return ('Survival ');\n    case 'Piercing Weapons':\n      return ('Melee Weapons (Piercing Weapons)');\n    case 'Jack o\\' Trades':\n      switch (compendium) {\n        case 'CE':\n          return ('Jack of All Trades');\n        case 'CL':\n          return ('Jack-of-All-Trades');\n      }\n      break;\n    case 'Melee Combat':\n      return ('Melee');\n    case 'Demolitions':\n      return ('Demolition / Explosives');\n    case 'Shotgun':\n      return ('Gun Combat (Shotguns)');\n    case 'Autopistol':\n      return ('Auto Pistol');\n    case 'Carousing':\n      return ('Carouse');\n    case 'Computer':\n      return ('Computers');\n    case 'Administration':\n      return ('Admin');\n    case 'Investigation':\n      return ('Investigate');\n    case 'Grav Vehicle':\n      return ('Grav Vehicles');\n  }\n}",
  "flags": {
    "core": {},
    "cf": {
      "id": "temp_f2ldg9aw4y"
    }
  },
  "ownership": {
    "default": 0,
    "g35c71Hsyv7w1Lw4": 3
  },
  "_stats": {
    "compendiumSource": "Macro.JiYaxclkfGY70Tnl",
    "duplicateSource": null,
    "coreVersion": "13.350",
    "systemId": "twodsix",
    "systemVersion": "6.8.1",
    "createdTime": 1738176323611,
    "modifiedTime": 1760016422571,
    "lastModifiedBy": "g35c71Hsyv7w1Lw4",
    "exportSource": null
  },
  "folder": null,
  "_id": "U7HtHGOj8AemOeVg",
  "sort": 1200000,
  "_key": "!macros!U7HtHGOj8AemOeVg"
}
