{
  "name": "Import Cepheus SRD Subsector v13",
  "type": "script",
  "scope": "global",
  "author": "g35c71Hsyv7w1Lw4",
  "img": "systems/twodsix/assets/icons/astrogation.svg",
  "command": "// Simple planet creator based on information from Cepheus Light, Cepheus Engine\n// SRD and https://travellermap.com/doc/secondsurvey#uwp\n// GEnie / SEC Format for input\n// using the generator https://www.orffenspace.com/cepheus-srd/tools/subsector-generator.html\n//updated for v13\n//\n// Fields used\n// 1-13: Name\n// 15-18: HexNbr\n// 20-28: UWP\n// 30: Bases\n// 49: Zone\n// 54: Number of Gas Giants\nconst gridSize = 115.47;\n\ntranslateCode();\n\nasync function translateCode () {\n  let topLabel = '';\n  const value = await new Promise((resolve) => {\n    new foundry.applications.api.DialogV2({\n      modal: true,\n      window: {\n        title: 'Enter World GEnie Code Block',\n        icon: 'fa-solid fa-globe'\n      },\n      content: `<label>Enter subsector block</label><textarea type=\"text\" name=\"input\" cols=\"40\" rows=\"5\"></textarea>`,\n      buttons: [\n        {\n          action: 'uwp',\n          label: 'UWP',\n          callback: (_event, target) => {\n            resolve(target.form.elements.input.value);\n            topLabel = 'UWP';\n          }\n        },\n        {\n          action: 'tradeCodes',\n          label: 'Trade Codes',\n          callback: (_event, target) => {\n            resolve(target.form.elements.input.value);\n            topLabel = 'Trade';\n          }\n        }\n      ]\n    }).render(true);\n  });\n\n  if (value !== '') {\n    // parse input text block into lines\n    const processedText = value.split('\\n');\n\n    const newNotes = [];\n    let newDrawings = [];\n    let newTiles = [];\n    let maxX = 0;\n    let maxY = 0;\n\n    // new journal entry\n    const newJournal = await JournalEntry.create({\n      name: \"New Subsector\"\n    });\n\n\n    // add new journal entries, notes, and drawing text for each planet\n    for (let i = 0; i < processedText.length; ++i) {\n      const parse = parseCode(processedText[i]);\n      let planetData = await newPlanet(parse, newJournal, topLabel);\n      newNotes.push(planetData.note);\n      newTiles = newTiles.concat(planetData.returnTiles);\n      newDrawings = newDrawings.concat(planetData.returnDrawing);\n      // adjust initial display position\n      if (planetData.note.x > maxX) {\n        maxX = planetData.note.x;\n      }\n      if (planetData.note.y > maxY) {\n        maxY = planetData.note.y;\n      }\n    }\n\n    Scene.create({\n      name: 'Temp Scene',\n      active: false,\n      navigation: true,\n      backgroundColor: '#000000',\n      grid: {\n        size: gridSize* Math.sqrt(3.0) / 2.0,\n        type: CONST.GRID_TYPES.HEXEVENQ,\n        color: '#c4c4c4'\n\t    },\n      notes: newNotes,\n      drawings: newDrawings,\n      initial: {\n        x: Math.round(maxX / 2),\n        y: Math.round(maxY / 2),\n        scale: 0.7\n      },\n      tiles: newTiles,\n      padding: 0.05,\n      width: maxX,\n      height: maxY\n    });\n  }\n}\n\nasync function newPlanet (parse, newJournal, topLabel) {\n  const addedPlanet = await newJournal.createEmbeddedDocuments(\"JournalEntryPage\",[{\n    text: {content: parse.text},\n    name: parse.planetName\n  }]);\n\n  // Calculate pixel position of items to display\n  const lrgFontSize = 14;\n  const smFontSize = lrgFontSize - 2;\n  const minSize = 36;\n  const maxSize = Math.max((gridSize * Math.sqrt(3.0) / 2.0 - 2.5 * lrgFontSize), minSize);\n  const iconSize = parseInt(minSize + (maxSize - minSize) * hexToBase10(parse.UWP[1]) / 10.0);\n  const iconPos = getPixelFromHex(parse.col, parse.row);\n  const yOffset = 0.5 * iconSize + 0.7 * lrgFontSize;\n\n  // Pick top label to use\n  let topText = '';\n  if (topLabel === 'UWP') {\n    topText = parse.UWP;\n  } else {\n    topText = parse.tCodes;\n  }\n\n  // Pick planet icon\n  let planetIcon = 'systems/twodsix/assets/icons/Starport' + parse.UWP[0] + '.svg';\n  if (parse.UWP[1] === '0') {\n    planetIcon = 'systems/twodsix/assets/icons/asteroid-' + parse.UWP[0] + '.svg';\n  }\n\n  // generate note and drawing objects\n  // add note and icon\n  const returnNote = {\n    entryId: newJournal.id,\n    pageId: addedPlanet[0].id,\n    text: '-',\n    fontSize: smFontSize,\n    textAnchor: CONST.TEXT_ANCHOR_POINTS.CENTER,\n    x: iconPos.x,\n    y: iconPos.y,\n    texture: {\n      src: planetIcon,\n      tint: parse.color,\n    },\n    iconSize: iconSize,\n    width: smFontSize + 2,\n    height: smFontSize + 2,\n    strokeWidth: 0\n\n  };\n\n  const returnDrawing = [\n    // add planet name\n    {\n      x: Math.round(iconPos.x - measureText(parse.planetName, lrgFontSize)/2 - 1),\n      y: Math.round(iconPos.y + yOffset - lrgFontSize/2 - 1),\n      z: 20,\n      text: parse.planetName.replace(' ', '\\xa0'),\n      fontSize: lrgFontSize,\n      shape: {\n        width: measureText(parse.planetName, lrgFontSize) + 2,\n        height: lrgFontSize + 2\n      },\n      textColor: '#ffffff',\n      strokeWidth: 0,\n      strokeColor: \"#000000\"\n    },\n    // add UWP or trade codes\n    {\n      text: topText,\n      x: Math.round(iconPos.x - measureText(topText, smFontSize)/2 - 1),\n      y: Math.round(iconPos.y - yOffset - smFontSize/2 - 1),\n      z: 20,\n      shape: {\n        width: measureText(topText, smFontSize) + 2,\n        height: smFontSize + 2,\n      },\n      textColor: '#ffffff',\n      fontSize: smFontSize,\n      strokeWidth: 0,\n      strokeColor: \"#000000\"\n    }\n  ];\n\n  // add gas giant or base markers if applicable\n  const returnTiles = [];\n  for (let i = 0; i < parse.markers.length; ++i) {\n    returnTiles.push({\n      x: Math.round(iconPos.x + iconSize / 2 + smFontSize / 4),\n      y: Math.round(iconPos.y + smFontSize * (i - 0.5 * parse.markers.length)),\n      z: 20,\n      width: smFontSize,\n      height: smFontSize,\n      texture: {\n        tint: '#d6d6d6',\n        src: 'systems/twodsix/assets/icons/' + getMarkerIcon(parse.markers[i])\n      }\n    });\n  }\n\n  // add planet icon again incase notes are turned off\n  returnTiles.push({\n    x: Math.round(iconPos.x - iconSize / 2),\n    y: Math.round(iconPos.y - iconSize / 2),\n    z: 20,\n    width: iconSize,\n    height: iconSize,\n    texture: {\n      tint: parse.color,\n      src: planetIcon\n    }\n  });\n\n  // add color for Zone\n  let zoneColor = '#ffffff';\n  switch (parse.zone) {\n    case 'A':\n      zoneColor = '#cc9a06';\n      break;\n    case 'R':\n      zoneColor = '#ff0000';\n      break;\n  }\n  // Add allegiance\n  returnDrawing.push({\n    text: parse.aleg,\n    x: Math.round(iconPos.x - iconSize/2 - measureText(parse.aleg, smFontSize) - 4),\n    y: iconPos.y - smFontSize/2 - 1,\n    z: 20,\n    textColor: zoneColor,\n    fontSize: smFontSize,\n    shape: {\n      width: measureText(parse.aleg, smFontSize) + 2,\n      height: smFontSize + 2\n    },\n    strokeWidth: 0,\n    strokeColor: \"#000000\"\n  });\n\n  return ({ note: returnNote, returnDrawing: returnDrawing, returnTiles: returnTiles });\n}\n\nfunction getMarkerIcon (textSymbol) {\n  switch (textSymbol) {\n    case 'N':\n      return ('star-formation.svg');\n    case 'P':\n      return ('pirate-skull.svg');\n    case 'S':\n      return ('scout-ship.svg');\n    case 'G':\n      return ('jupiter.svg');\n    default:\n      return ('perspective-dice-six-faces-random.svg');\n  }\n}\n\nfunction getPixelFromHex (col, row) {\n  const width = gridSize;\n  const sqrt3 = Math.sqrt(3.0);\n\n  // Add +1 offset due to needing non-zero padding\n  const xPixel = Math.round((0.75 * (col + 1) + 0.5) * width);\n  const yPixel = Math.round(((row + 1) + 0.5 * ((col + 1) & 1) + 0.5) * sqrt3 / 2.0 * width);\n\n  return ({\n    x: xPixel,\n    y: yPixel\n  });\n}\n\nfunction parseCode (profile) {\n  const planetName = profile.substring(0, 13).trim();\n  const column = Number(profile.substring(14, 16));\n  const row = Number(profile.substring(16, 18));\n  const UWP = profile.substring(19, 28);\n  const bases = profile[29];\n  let retZone = profile[48];\n  const allegiance = profile.substring(55, 57);\n\n  // Strip out dash from UWP\n  const cleanUWP = UWP.substring(0, 7) + UWP[8];\n\n  const UWPtables = [\n    'Starport Type', 'World Size - CL', 'Atmosphere', 'Hydrographics',\n    'Population', 'Government', 'Law Level - CL', 'Tech Level - CL'\n  ];\n  let planetDescrip = `<table style=\"width=95%; margin: 12px;\"><tbody><tr><th style =\"width: 20%;\">Characteristic</th><th style =\"width: 70%;\">Description</th></tr>`;\n  // parse starport, this is non-numeric\n  planetDescrip += `<tr><td style=\"padding-right: 5px;\">${UWPtables[0]} (${\n    cleanUWP[0]})</td><td>${getStarportDescr(cleanUWP[0])}</td></tr>`;\n\n  // process rest of UWP\n  for (let i = 1; i < Math.min(profile.length, UWPtables.length); i++) {\n    planetDescrip += `<tr>${getUWPparameter(cleanUWP[i], UWPtables[i])}</tr>`;\n  }\n\n  // generate trade codes\n  const trData = getTradeCodes(cleanUWP);\n  planetDescrip += trData.text;\n  planetDescrip += `</tbody></table>`;\n\n  // set zone color\n  if (retZone === ' ') {\n    retZone = trData.zone;\n  }\n\n  // add base and gas giant codes\n  const markers = [];\n  if (profile[53] !== '0') {\n    markers.push('G');\n  }\n  switch (bases) {\n    case 'N':\n      markers.push('N');\n      break;\n    case 'S':\n      markers.push('S');\n      break;\n    case 'P':\n      markers.push('P');\n      break;\n    case 'A':\n      markers.push('N');\n      markers.push('S');\n      break;\n    case 'G':\n      markers.push('S');\n      markers.push('P');\n      break;\n  }\n\n  return ({ planetName: planetName, col: column, row: row, UWP: UWP, text: planetDescrip, color: trData.color, tCodes: trData.tCodes, markers: markers, zone: retZone, aleg: allegiance });\n}\n\n// Lookup a hex digit from a roll table\nfunction getUWPparameter (value, tableName) {\n  const item = hexToBase10(value);\n  const table = game.tables.contents.find(t => t.name === tableName);\n\n  if (item < table.results.size) {\n    const details = table.results._source[item].text;\n    return (`<td style=\"padding-right:5px\">${tableName} (${value})</td><td>${details}</td>`);\n  } else {\n    return (`<td style=\"padding-right:5px\">${tableName} (${value})</td><td>UNKNOWN TABLE ITEM</td>`);\n  }\n}\n\n// Convert hex value to base10\nfunction hexToBase10 (value) {\n  switch (value.toUpperCase()) {\n    case 'A':\n      return (10);\n    case 'B':\n      return (11);\n    case 'C':\n      return (12);\n    case 'D':\n      return (13);\n    case 'E':\n      return (14);\n    case 'F':\n      return (15);\n    case 'G':\n      return (16);\n    default:\n      return (parseInt(value));\n  }\n}\n\n// Lookup starport description (letter values that are not hex)\nfunction getStarportDescr (value) {\n  let rtext = '';\n  switch (value.toUpperCase()) {\n    case 'A':\n      rtext =\n        'Excellent Quality. Refined fuel and annual maintenance overhaul available. Shipyard capable of constructing starships and non-starships present.';\n      break;\n    case 'B':\n      rtext =\n        'Good Quality. Refined fuel and annual maintenance overhaul available. Shipyard capable of constructing non-starships present.';\n      break;\n    case 'C':\n      rtext =\n        'Routine Quality. Only unrefined fuel available. Reasonable repair facilities present.';\n      break;\n    case 'D':\n      rtext =\n        'Poor Quality. Only unrefined fuel available. No repair facilities present.';\n      break;\n    case 'E':\n      rtext =\n        'Frontier Installation. Essentially a marked spot of bedrock with no fuel, facilities, or bases present.';\n      break;\n    case 'X':\n      rtext = 'No Starport. No provision is made for any ship landings.';\n      break;\n    default:\n      rtext = 'Unknown';\n  }\n  return (rtext);\n}\n\n// Generate Trade Codes per Cepheus Light Rules\nfunction getTradeCodes (profile) {\n  let rtext = '';\n  let rCode = '';\n  let rColor = '#ffffff';\n  let zText = '';\n\n  if (profile.length < 8) {\n    rtext += 'UWP Code too short</td></tr>';\n  } else {\n    const size = hexToBase10(profile[1]);\n    const atmo = hexToBase10(profile[2]);\n    const hydro = hexToBase10(profile[3]);\n    const pop = hexToBase10(profile[4]);\n    const gov = hexToBase10(profile[5]);\n    const law = hexToBase10(profile[6]);\n    const techL = hexToBase10(profile[7]);\n\n    if (atmo > 3 && atmo < 10 && hydro > 3 && hydro < 9 && pop > 4 && pop < 8) {\n      rtext += 'Ag - Agricultural, ';\n      rCode += 'Ag\\xa0';\n    }\n\n    if (size === 0 && atmo === 0 && hydro === 0) {\n      rtext += 'As - Asteroid, ';\n      rCode += 'As\\xa0';\n    }\n\n    if (pop === 0) {\n      rtext += 'Ba - Barren, ';\n      rCode += 'Ba\\xa0';\n      rColor = '#999999';\n    }\n\n    if (atmo > 1 && hydro === 0) {\n      rtext += 'De - Desert, ';\n      rCode += 'De\\xa0';\n      rColor = '#cc8800';\n    }\n\n    if (atmo > 9 && hydro > 0) {\n      rtext += 'Fl - Non-water Fluid Oceans, ';\n      rCode += 'Fl\\xa0';\n      rColor = '#ff6600';\n    }\n\n    if ((atmo === 5 || atmo === 6 || atmo === 8) && hydro > 3 && hydro < 10 && pop > 3 && pop < 9) {\n      rtext += 'Ga - Garden, ';\n      rCode += 'Ga\\xa0';\n      rColor = '#009900';\n    }\n\n    if (pop > 8) {\n      rtext += 'Hi - High Population, ';\n      rCode += 'Hi\\xa0';\n    }\n\n    if (techL > 11) {\n      rtext += 'Ht - High Technology, ';\n      rCode += 'Ht\\xa0';\n    }\n\n    if (atmo < 2 && hydro > 0) {\n      rtext += 'Ic - Ice Capped, ';\n      rCode += 'Ic\\xa0';\n      rColor = '#ccccff';\n    }\n\n    if ((atmo < 3 || atmo === 4 || atmo === 7 || atmo === 9) && pop > 8) {\n      rtext += 'In - Industrial, ';\n      rCode += 'In\\xa0';\n    }\n\n    if (pop > 0 && pop < 4) {\n      rtext += 'Lo - Low Population, ';\n      rCode += 'Lo\\xa0';\n    }\n\n    if (techL < 6) {\n      rtext += 'Lt - Low Technology, ';\n      rCode += 'Lt\\xa0';\n    }\n\n    if (atmo < 4 && hydro < 4 && pop > 5) {\n      rtext += 'Na - Non Agricultural, ';\n      rCode += 'Na\\xa0';\n    }\n\n    if (pop > 3 && pop < 7) {\n      rtext += 'Ni - Non Industrial, ';\n      rCode += 'Ni\\xa0';\n    }\n\n    if (atmo > 1 && atmo < 6 && hydro < 4) {\n      rtext += 'Po - Poor, ';\n      rCode += 'Po\\xa0';\n    }\n\n    if ((atmo === 6 || atmo === 8) && pop > 5 && pop < 9) {\n      rtext += 'Ri - Rich, ';\n      rCode += 'Ri\\xa0';\n    }\n\n    if (hydro === 10) {\n      rtext += 'Wa - Water World, ';\n      rCode += 'Wa\\xa0';\n      rColor = '#3366cc';\n    }\n\n    if (atmo === 0) {\n      rtext += 'Va - Vacuum, ';\n      rCode += 'Va\\xa0';\n    }\n    // Get rid of extra coma and space\n    if (rtext.length > 0) {\n      rtext = rtext.slice(0, -2);\n    }\n    rtext += '</td></tr>';\n    // get rid of extra comma\n    if (rCode.length > 0) {\n      rCode = rCode.slice(0, -1);\n    }\n\n    if (atmo > 9 || (gov === 0 || gov === 7 || gov === 10) || (law === 0 || law > 8)) {\n      zText = 'A';\n    }\n  }\n\n  return ({ text: `<tr><td \"padding-right:5px\">Trade Codes</td><td>${rtext}`, color: rColor, tCodes: rCode, zone: zText });\n}\n\n//from https://www.codegrepper.com/code-examples/javascript/calculate+width+of+text+javascript\nfunction measureText(str, fontSize = 10) {\n  const widths = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.2796875,0.2765625,0.3546875,0.5546875,0.5546875,0.8890625,0.665625,0.190625,0.3328125,0.3328125,0.3890625,0.5828125,0.2765625,0.3328125,0.2765625,0.3015625,0.5546875,0.5546875,0.5546875,0.5546875,0.5546875,0.5546875,0.5546875,0.5546875,0.5546875,0.5546875,0.2765625,0.2765625,0.584375,0.5828125,0.584375,0.5546875,1.0140625,0.665625,0.665625,0.721875,0.721875,0.665625,0.609375,0.7765625,0.721875,0.2765625,0.5,0.665625,0.5546875,0.8328125,0.721875,0.7765625,0.665625,0.7765625,0.721875,0.665625,0.609375,0.721875,0.665625,0.94375,0.665625,0.665625,0.609375,0.2765625,0.3546875,0.2765625,0.4765625,0.5546875,0.3328125,0.5546875,0.5546875,0.5,0.5546875,0.5546875,0.2765625,0.5546875,0.5546875,0.221875,0.240625,0.5,0.221875,0.8328125,0.5546875,0.5546875,0.5546875,0.5546875,0.3328125,0.5,0.2765625,0.5546875,0.5,0.721875,0.5,0.5,0.5,0.3546875,0.259375,0.353125,0.5890625];\n  const avg = 0.5279276315789471;\n  if (str) {\n    return str\n      .split('')\n      .map(c => c.charCodeAt(0) < widths.length ? widths[c.charCodeAt(0)] : avg)\n      .reduce((cur, acc) => acc + cur) * fontSize;\n  }\n}",
  "ownership": {
    "default": 0,
    "g35c71Hsyv7w1Lw4": 3
  },
  "flags": {
    "core": {}
  },
  "_stats": {
    "compendiumSource": null,
    "duplicateSource": null,
    "coreVersion": "13.350",
    "systemId": "twodsix",
    "systemVersion": "6.8.1",
    "createdTime": 1738176319577,
    "modifiedTime": 1760016422560,
    "lastModifiedBy": "g35c71Hsyv7w1Lw4",
    "exportSource": null
  },
  "folder": null,
  "_id": "1dNvQt1ociYYjRwq",
  "sort": 1100000,
  "_key": "!macros!1dNvQt1ociYYjRwq"
}
