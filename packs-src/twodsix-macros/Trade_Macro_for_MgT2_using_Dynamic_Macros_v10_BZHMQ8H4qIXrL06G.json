{
  "name": "Trade Macro for MgT2 using Dynamic Macros v10",
  "type": "script",
  "scope": "global",
  "author": "t9ZnVCF4OAyCodMB",
  "img": "systems/twodsix/assets/icons/cargo-crate.svg",
  "command": "/* eslint-disable no-undef */\n/* eslint-disable semi */\n// Macro to generated trade goods pricing and quantities for sale based on\n// planet UPP passed by Dynamic Macro Link\n// when using Dynamic Macro Link in a journal entry, make sure to enter the world name first, followed by the UPP, e.g. @2eTrade[Regina;A753C55-EA]{2e Trade Goods}\n// UPP can contain travel zone (A/R) after TL, e.g. A753C55-EA, mostly important for illegal goods\n// when setting up rollable tables for trade goods, make sure any DM bigger than 9 is written in hexcode, e.g. DM+10 becomes DM+A\n// also, trade good availability is based on purchase DM, not a seperate column, so if you want to include a trade good that has not purchase modifer in 2e, set the modifer to +0 to include it anyways\n\nconst DEBUG = false; // Display debugging info to console\nconst RANDOM = true; // Whether trade goods for player to buy are selected at random (true).  Otherwise, goods available are determined by trade codes.\nconst planetName = args[0];\nconst uwp = args[1];\ngenerateTable(uwp);\n\nasync function generateTable (uwp) {\n  let traderDM = 0;\n  const compendium = 'CL';\n  await new Promise((resolve) => {\n    new Dialog({\n      content: `\n      <input placeholder = \"Player Broker - Trader Broker\" type=\"number\" name=\"traderDM\"/>`,\n      title: 'Generate Trade Table',\n      buttons: {\n        TE: {\n          label: 'Okay',\n          callback: btn => {\n            resolve(traderDM = btn.find(\"[name='traderDM']\").val());\n          }\n        }\n      }\n\n    }).render(true);\n  });\n  const tcodes = getTradeCode(uwp);\n  if (traderDM === '') { traderDM = 0; }\n  const tcodesFlat = planetName + ' (' + uwp + ', ' + tcodes.join(', ') + '), Trader DM: ' + traderDM;\n  const starBase = uwp[0];\n  const population = hexToBase10(uwp[4]);\n\n  if (DEBUG) {\n    console.log('Trade codes:', tcodes);\n  }\n  if (DEBUG) {\n    console.log('UWP: ', uwp, traderDM);\n  }\n\n  let tradeTable = '';\n  tradeTable +=\n      processTradeTable('Advanced Trade Goods - ' + compendium, tcodes,\n        parseInt(traderDM), compendium, starBase, population);\n\n  tradeTable += processTradeTable('Basic Goods - ' + compendium, tcodes,\n    parseInt(traderDM), compendium, starBase, population);\n\n  const htmlContent = `<table><tbody><tr>\n      <th style=\"text-align:left\">Good</th>\n      <th style=\"text-align:center\">Available to Buy (tons)</th>\n      <th style=\"text-align:center\">Player Buys (Cr)</th>\n      <th style=\"text-align:center\">Player Sells (Cr)</th></tr>\n      ${tradeTable}\n      </tbody></table>`;\n\n  await new Promise((resolve) => {\n    new Dialog({\n      modal: true,\n      title: `Trade Table for: ${tcodesFlat}`,\n      content: htmlContent,\n      buttons: {\n        Ok: {\n          label: 'Ok',\n          callback: (html) => { resolve(html.find('input').val()); },\n          height: '12px',\n          resizable: true\n        },\n        Output: {\n          label: 'Output',\n          callback: (html) => {\n            JournalEntry.create({\n              name: 'Trade Output',\n              content: htmlContent\n            });\n          },\n          height: '12px',\n          resizable: true\n        }\n      }\n    },\n    { width: 700, height: 600 })\n      .render(true);\n  });\n}\n\nfunction processTradeTable (tableName, trcodes, offset, compendium, starBase, population) {\n  let returnText = '';\n  let isAvailable = [];\n  const table = game.tables.contents.find(t => t.name === tableName);\n\n  // If random selection, determine trade goods available\n  if ((tableName.indexOf('Basic') === -1 && RANDOM) || compendium === '2e') {\n    isAvailable = determineGoods(table, compendium, starBase, population);\n  }\n  if (DEBUG) {\n    console.log(isAvailable);\n  }\n\n  // Process each item (good) in table\n  for (let row = 0; row < table.results.size; ++row) {\n    // Parse row of table that is tab delimited\n    const details = table.results._source[row].text.split('\\t');\n\n    let tons = 0;\n    let pSellPr = 0;\n    let pBuyPr = 0;\n    let pBuyMod = 0;\n    let pSellMod = 0;\n    let popModifier = 0;\n\n    // Determine planet trade code price DMs\n    switch (compendium) {\n      case 'CL':\n        pSellMod = getMod(trcodes, details[4]);\n        pBuyMod = getMod(trcodes, details[3]);\n        break;\n      case 'CE':\n      case '2e':\n        pSellMod = getMod(trcodes, details[4]) - getMod(trcodes, details[3]);\n        pBuyMod = getMod(trcodes, details[3]) - getMod(trcodes, details[4]);\n        break;\n    }\n\n    if (DEBUG) {\n      console.log('Name: ', details[0]);\n    }\n    if (DEBUG) {\n      console.log('pSellMod:', pSellMod);\n    }\n    if (DEBUG) {\n      console.log('pBuyMod:', pBuyMod);\n    }\n    // Determine Population modifier for tonnage\n    if (population <= 3) {\n      popModifier = -3;\n    } else if (population >= 9) {\n      popModifier = +3;\n    }\n\n    // Determine tons available for player to buy\n    if (DEBUG) {\n      console.log('dice: ', details[2], ', popMod: ', popModifier);\n    }\n    if (RANDOM) {\n      tons = Math.max(new Roll('@dice + @DM', { dice: details[2], DM: popModifier }).evaluate({ async: false }).total, 0);\n      if (tableName.indexOf('Basic') === -1) {\n        tons *= isAvailable[row];\n      }\n    } else {\n      if (tableName.indexOf('Basic') !== -1) {\n        tons = Math.max(new Roll('@dice + @DM', { dice: details[2], DM: popModifier }).evaluate({ async: false }).total, 0);\n      } else if (availableGood(trcodes, details[3])) {\n        tons = Math.max(new Roll('@dice + @DM', { dice: details[2], DM: popModifier }).evaluate({ async: false }).total, 0);\n      } else if (compendium === '2e') {\n        tons = Math.max(new Roll('@dice + @DM', { dice: details[2], DM: popModifier }).evaluate({ async: false }).total, 0);\n      }\n    }\n\n    // Determine Player Buys price\n    if (tons === 0) {\n      tons = '---';\n      pBuyPr = '---';\n    } else {\n      pBuyPr = Math.round(details[1] * rollPriceAdjust(pBuyMod + offset, 'buy', compendium));\n    }\n\n    // Determine Player Sells price\n    pSellPr = Math.round(\n      details[1] * rollPriceAdjust(pSellMod + offset, 'sell', compendium));\n\n    // generate buy-sell table row in html\n    if (row === table.results.size - 1) {\n      returnText +=\n          `<tr style=\"border-bottom:1px solid red\"><td style=\"padding-right:5px\">${details[0]}</td>`;\n    } else {\n      returnText += `<tr><td style=\"padding-right:5px\">${details[0]}</td>`;\n    }\n\n    returnText += `<td style=\"padding-right:5px; text-align:center\">${tons}</td>\n    <td style=\"padding-right:5px; text-align:center\">${pBuyPr}</td><td style=\"padding-right:5px; text-align:center\">${pSellPr}</td></tr>`;\n  }\n\n  return (returnText);\n}\n\nfunction determineGoods (table, compendium, starBase, population) {\n  const numItems = table.results.size;\n  // fill with zeros\n  const availList = new Uint8Array(numItems);\n\n  let baseAdj = 0;\n\n  // Calculate starport roll bonus if Cepheus Light\n  if (compendium === 'CL') {\n    switch (starBase.toUpperCase()) {\n      case 'A':\n        baseAdj = 4;\n        break;\n      case 'B':\n        baseAdj = 2;\n        break;\n      case 'C':\n        baseAdj = 1;\n        break;\n      case 'D':\n        baseAdj = 0;\n        break;\n      case 'E':\n        baseAdj = -2;\n        break;\n    }\n  }\n\n  let numDraws = 0;\n  if (compendium === '2e') {\n    numDraws = population;\n  } else {\n    numDraws = Math.max(1, new Roll('1D6+@adj', { adj: baseAdj }).evaluate({ async: false }).total);\n  }\n\n  if (DEBUG) {\n    console.log('Number of Draws: ', numDraws);\n  }\n\n  for (let i = 0; i < numDraws; ++i) {\n    const item = new Roll('1D@num', { num: numItems }).evaluate({ async: false }).total;\n    ++availList[item - 1];\n  }\n  return (availList);\n}\n\nfunction getMod (planetTrCodes, goodCodes) {\n  let modifier = 0;\n  for (const code of planetTrCodes) {\n    const codePos = goodCodes.indexOf(code);\n    if (codePos !== -1) {\n      const codeValue = hexToBase10(goodCodes[codePos + 3]);\n      if (codeValue > modifier) {\n        modifier = codeValue;\n      }\n    }\n  }\n  return (parseInt(modifier));\n}\n\nfunction rollPriceAdjust (offset, type, compendium) {\n  let tableName = '';\n  if (type === 'sell') {\n    tableName += 'Sales Price Table';\n  } else {\n    tableName += 'Purchase Price Table';\n  }\n  tableName += ` - ${compendium}`;\n\n  if (DEBUG) {\n    console.log('Price Adjustment Table: ', tableName);\n  }\n\n  const table = game.tables.contents.find(t => t.name === tableName);\n\n  const r = new Roll('3D6+@mod', { mod: offset }).evaluate({ async: false }).total;\n  const details =\n      table.results._source[Math.min(Math.max(r - 2, 0), table.results.size - 1)].text;\n\n  if (DEBUG) {\n    console.log('Roll on Adj Table: ', r);\n  }\n  if (DEBUG) {\n    console.log('Relative Price: ', details);\n  }\n  return (parseInt(details) / 100);\n}\n\nfunction availableGood (trcodes, goodCodes) {\n  for (const code of trcodes) {\n    if (goodCodes.indexOf(code) !== -1) {\n      return true;\n    }\n  }\n  return false;\n}\n\n// Generate Trade Codes per Cepheus Light Rules\nfunction getTradeCode (UWPprofile) {\n  const returnText = [];\n\n  // Strip out dash if used in profile\n  UWPprofile = UWPprofile.replace('-', '');\n\n  if (UWPprofile.length > 7) {\n    const size = hexToBase10(UWPprofile[1]);\n    const atmo = hexToBase10(UWPprofile[2]);\n    const hydro = hexToBase10(UWPprofile[3]);\n    const pop = hexToBase10(UWPprofile[4]);\n    const gov = hexToBase10(UWPprofile[5]);\n    const law = hexToBase10(UWPprofile[6]);\n    const techL = hexToBase10(UWPprofile[7]);\n    if (UWPprofile[8]) {\n      const travelZ = UWPprofile[8];\n      if (travelZ === 'A' || travelZ === 'a') {\n        returnText.push('Az');\n      }\n      if (travelZ === 'R' || travelZ === 'r') {\n        returnText.push('Rz');\n      }\n    }\n\n    if (atmo > 3 && atmo < 10 && hydro > 3 && hydro < 9 && pop > 4 && pop < 8) {\n      returnText.push('Ag');\n    }\n\n    if (size === 0 && atmo === 0 && hydro === 0) {\n      returnText.push('As');\n    }\n\n    if (pop === 0 && gov === 0 && law === 0) {\n      returnText.push('Ba');\n    }\n\n    if (atmo > 1 && atmo < 10 && hydro === 0) {\n      returnText.push('De');\n    }\n\n    if (atmo > 9 && hydro > 0) {\n      returnText.push('Fl');\n    }\n\n    if (size > 5 && size < 9 && (atmo === 5 || atmo === 6 || atmo === 8) && hydro > 4 && hydro < 8) {\n      returnText.push('Ga');\n    }\n\n    if (pop > 8) {\n      returnText.push('Hi');\n    }\n\n    if (techL > 11) {\n      returnText.push('Ht');\n    }\n\n    if (atmo < 2 && hydro > 0) {\n      returnText.push('Ic');\n    }\n\n    if ((atmo < 3 || atmo === 4 || atmo === 7 || (atmo > 8 && atmo < 13)) && pop > 8) {\n      returnText.push('In');\n    }\n\n    if (pop > 0 && pop < 4) {\n      returnText.push('Lo');\n    }\n\n    if (pop > 0 && techL < 6) {\n      returnText.push('Lt');\n    }\n\n    if (atmo < 4 && hydro < 4 && pop > 5) {\n      returnText.push('Na');\n    }\n\n    if (pop > 3 && pop < 7) {\n      returnText.push('Ni');\n    }\n\n    if (atmo > 1 && atmo < 6 && hydro < 4) {\n      returnText.push('Po');\n    }\n\n    if ((atmo === 6 || atmo === 8) && pop > 5 && pop < 9 && gov > 3 && gov < 10) {\n      returnText.push('Ri');\n    }\n\n    if (((atmo > 2 && atmo < 10) || atmo > 12) && hydro === 10) {\n      returnText.push('Wa');\n    }\n\n    if (atmo === 0) {\n      returnText.push('Va');\n    }\n  }\n  return (returnText);\n}\n\n// Convert hex value to base10\nfunction hexToBase10 (value) {\n  switch (value.toUpperCase()) {\n    case 'A':\n      return (10);\n    case 'B':\n      return (11);\n    case 'C':\n      return (12);\n    case 'D':\n      return (13);\n    case 'E':\n      return (14);\n    case 'F':\n      return (15);\n    case 'G':\n      return (16);\n    default:\n      return (Number(value));\n  }\n}",
  "ownership": {
    "default": 0,
    "t9ZnVCF4OAyCodMB": 3
  },
  "flags": {
    "core": {}
  },
  "_stats": {
    "systemId": "twodsix",
    "systemVersion": "6.8.1",
    "coreVersion": "13.350",
    "createdTime": 1659016930086,
    "modifiedTime": 1760016422561,
    "lastModifiedBy": "g35c71Hsyv7w1Lw4",
    "compendiumSource": "Macro.dOkWBot083nAxnqi",
    "duplicateSource": null,
    "exportSource": null
  },
  "folder": null,
  "sort": 1600000,
  "_id": "BZHMQ8H4qIXrL06G",
  "_key": "!macros!BZHMQ8H4qIXrL06G"
}
